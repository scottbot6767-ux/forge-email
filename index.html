<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FORGE — Email Builder</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{--bg:#0c0c0c;--sf:#131313;--bd:#222;--bd2:#2a2a2a;--ac:#D4FF00;--tx:#e8e8e8;--dm:#666;--mt:#444}
    html,body{height:100%;background:var(--bg);color:var(--tx);font-family:'Syne',sans-serif;overflow:hidden}

    .toolbar{height:52px;background:var(--sf);border-bottom:1px solid var(--bd);display:flex;align-items:center;padding:0 18px;gap:12px;flex-shrink:0;z-index:10}
    .wm{font-size:15px;font-weight:800;letter-spacing:3px;text-transform:uppercase;color:var(--ac);user-select:none}
    .pipe{width:1px;height:20px;background:var(--bd2);flex-shrink:0}
    .mp{display:flex;background:var(--bg);border:1px solid var(--bd);border-radius:3px;overflow:hidden}
    .mp button{padding:5px 14px;background:none;border:none;color:var(--dm);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all .12s}
    .mp button.on{background:var(--ac);color:#000;font-weight:500}
    .ts{background:var(--bg);border:1px solid var(--bd);color:var(--tx);font-family:'DM Mono',monospace;font-size:10px;padding:5px 10px;border-radius:3px;cursor:pointer;text-transform:uppercase;max-width:180px}
    .ts option{background:#1a1a1a}
    .sp{flex:1}
    .tst{font-family:'DM Mono',monospace;font-size:10px;color:var(--ac);opacity:0;transition:opacity .25s;pointer-events:none}
    .tst.show{opacity:1}
    .bcp{background:var(--ac);color:#000;border:none;padding:8px 20px;font-family:'Syne',sans-serif;font-weight:700;font-size:11px;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;border-radius:2px}
    .bcp:hover{opacity:.88}

    .layout{display:flex;height:calc(100vh - 52px)}

    /* SIDEBAR */
    .sidebar{width:290px;background:var(--sf);border-right:1px solid var(--bd);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}
    .sbs{overflow-y:auto;flex:1}
    .sbs::-webkit-scrollbar{width:3px}
    .sbs::-webkit-scrollbar-thumb{background:#2a2a2a}
    .sh{padding:10px 16px;font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2.5px;text-transform:uppercase;color:var(--mt);background:var(--sf);border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:2}

    /* fields */
    .fw{padding:9px 14px;border-bottom:1px solid var(--bd)}
    .fl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;color:var(--dm);text-transform:uppercase;margin-bottom:4px}
    .fi{width:100%;background:var(--bg);border:1px solid var(--bd);color:var(--tx);font-family:'DM Mono',monospace;font-size:11px;line-height:1.5;padding:6px 9px;border-radius:2px;transition:border-color .12s;resize:vertical}
    .fi:focus{outline:none;border-color:var(--ac)}
    textarea.fi{min-height:58px}
    .cr{display:flex;gap:6px;align-items:center}
    input[type="color"]{width:32px;height:28px;border:1px solid var(--bd);border-radius:2px;cursor:pointer;background:none;padding:1px;flex-shrink:0}
    .swr{display:flex;gap:4px;margin-top:5px;flex-wrap:wrap}
    .sw{width:20px;height:20px;border-radius:2px;cursor:pointer;border:1px solid rgba(255,255,255,.08);flex-shrink:0;transition:transform .1s,box-shadow .1s}
    .sw:hover{transform:scale(1.2);box-shadow:0 2px 8px rgba(0,0,0,.5);z-index:1}

    /* image zone */
    .iz{border:1px dashed #333;border-radius:3px;cursor:pointer;transition:all .15s;overflow:hidden;position:relative;margin-bottom:5px;min-height:60px;display:flex;align-items:center;justify-content:center;background:var(--bg)}
    .iz.drag-over{border-color:var(--ac);background:rgba(212,255,0,.04)}
    .iz.hi{border-style:solid;border-color:#2a2a2a}
    .iz-hint{display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px;pointer-events:none}
    .iz-icon{width:20px;height:20px;opacity:.2}
    .iz-txt{font-family:'DM Mono',monospace;font-size:9px;color:var(--mt);text-align:center;line-height:1.3}
    .iz-tw{width:100%;position:relative}
    .iz-th{width:100%;display:block;max-height:100px;object-fit:cover}
    .iz-rm{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.8);border:1px solid #444;color:#ccc;font-family:'DM Mono',monospace;font-size:9px;padding:2px 6px;border-radius:2px;cursor:pointer}
    .in{font-family:'DM Mono',monospace;font-size:9px;color:#3a3a3a;line-height:1.4;margin-top:3px}

    /* image controls */
    .ic{margin-top:6px;display:flex;flex-direction:column;gap:4px}
    .ir{display:flex;align-items:center;gap:5px}
    .il{font-family:'DM Mono',monospace;font-size:8px;color:var(--mt);text-transform:uppercase;width:40px;flex-shrink:0}
    .bg{display:flex;gap:3px}
    .bs{padding:3px 6px;background:var(--bg);border:1px solid var(--bd);color:var(--dm);font-family:'DM Mono',monospace;font-size:9px;border-radius:2px;cursor:pointer;transition:all .1s;white-space:nowrap}
    .bs:hover{border-color:#444;color:var(--tx)}
    .bs.on{background:var(--ac);border-color:var(--ac);color:#000;font-weight:500}
    .is{flex:1;background:var(--bg);border:1px solid var(--bd);color:var(--tx);font-family:'DM Mono',monospace;font-size:9px;padding:3px 6px;border-radius:2px;cursor:pointer}
    .is option{background:#1a1a1a}
    .ii{flex:1;background:var(--bg);border:1px solid var(--bd);color:var(--tx);font-family:'DM Mono',monospace;font-size:9px;padding:3px 6px;border-radius:2px}
    .ii:focus{outline:none;border-color:var(--ac)}

    /* BLOCKS */
    .bk-list{padding:8px 14px}
    .bk{border:1px solid var(--bd2);border-radius:3px;margin-bottom:6px;overflow:hidden;background:var(--bg)}
    .bk-hd{display:flex;align-items:center;gap:6px;padding:7px 10px;cursor:pointer;user-select:none;transition:background .1s}
    .bk-hd:hover{background:rgba(255,255,255,.03)}
    .bk-ico{width:18px;height:18px;background:var(--bd2);border-radius:2px;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:8px;color:var(--dm);flex-shrink:0}
    .bk-lbl{font-family:'DM Mono',monospace;font-size:10px;color:var(--tx);flex:1;letter-spacing:.3px}
    .bk-acts{display:flex;gap:3px;flex-shrink:0}
    .bk-btn{background:none;border:1px solid var(--bd2);color:var(--dm);font-family:'DM Mono',monospace;font-size:9px;padding:2px 6px;border-radius:2px;cursor:pointer;transition:all .1s}
    .bk-btn:hover{border-color:#444;color:var(--tx)}
    .bk-btn.del:hover{border-color:#c0392b;color:#c0392b}
    .bk-body{border-top:1px solid var(--bd2);display:none}
    .bk-body.open{display:block}
    .bk-field{padding:8px 10px;border-bottom:1px solid #1a1a1a}
    .bk-field:last-child{border-bottom:none}

    /* ADD BLOCK */
    .add-bk-wrap{padding:0 14px 12px}
    .add-bk-btn{width:100%;padding:8px;background:none;border:1px dashed var(--bd2);color:var(--dm);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;border-radius:3px;transition:all .12s}
    .add-bk-btn:hover{border-color:var(--ac);color:var(--ac)}
    .block-picker{display:none;border:1px solid var(--bd2);border-radius:3px;background:var(--sf);margin-top:6px;overflow:hidden}
    .block-picker.open{display:block}
    .bp-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--bd)}
    .bp-item{padding:8px 10px;background:var(--bg);cursor:pointer;transition:background .1s}
    .bp-item:hover{background:rgba(212,255,0,.06)}
    .bp-name{font-family:'DM Mono',monospace;font-size:10px;color:var(--tx);margin-bottom:1px}
    .bp-sub{font-family:'DM Mono',monospace;font-size:8px;color:var(--mt)}

    /* MERGE TAGS */
    .tw{padding:10px 14px}
    .tn{font-family:'DM Mono',monospace;font-size:9px;color:var(--mt);line-height:1.6;margin-bottom:7px}
    .tg{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:#3a3a3a;margin:7px 0 4px}
    .tr_{display:flex;flex-wrap:wrap;gap:4px}
    .tc{background:var(--bg);border:1px solid #2a2a2a;color:var(--ac);font-family:'DM Mono',monospace;font-size:8px;padding:3px 6px;border-radius:2px;cursor:pointer;transition:all .12s;white-space:nowrap}
    .tc:hover{border-color:var(--ac);background:rgba(212,255,0,.06)}

    /* PREVIEW */
    .pa{flex:1;background:#1c1c1c;overflow-y:auto;display:flex;flex-direction:column;align-items:center;padding:28px 24px}
    .pa::-webkit-scrollbar{width:6px}
    .pa::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
    .pm{display:flex;align-items:center;gap:10px;align-self:stretch;margin-bottom:18px}
    .pl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#3a3a3a}
    .prl{flex:1;height:1px;background:#252525}
    .esw{width:600px;box-shadow:0 24px 80px rgba(0,0,0,.6),0 4px 16px rgba(0,0,0,.4)}
    #pf{width:600px;border:none;display:block;min-height:400px}
    #fui{display:none}
  </style>
</head>
<body>
<input type="file" id="fui" accept="image/*">

<div class="toolbar">
  <div class="wm">Forge</div>
  <div class="pipe"></div>
  <div class="mp">
    <button class="on" onclick="setMode('marketing')">Marketing</button>
    <button onclick="setMode('sales')">Sales</button>
  </div>
  <select class="ts" id="ts" onchange="setTpl(this.value)"></select>
  <div class="sp"></div>
  <span class="tst" id="tst"></span>
  <button class="bcp" onclick="copyHTML()">Copy HTML</button>
</div>

<div class="layout">
  <div class="sidebar"><div class="sbs" id="sb"></div></div>
  <div class="pa">
    <div class="pm"><span class="pl">Live Preview</span><div class="prl"></div><span class="pl">600px</span></div>
    <div class="esw"><iframe id="pf" srcdoc="" scrolling="no"></iframe></div>
  </div>
</div>

<script>
// ── STATE ────────────────────────────────────────────────────────────────────
let mode='marketing', tplKey='', ff={}, blocks=[], pendingImg=null, pendingImgBk=null;
let expandedBlks=new Set();
let showPicker=false;

// ── CONSTANTS ─────────────────────────────────────────────────────────────────
const BRAND=[
  {n:'Tuxedo',h:'#282828'},{n:'Suede',h:'#fcfaec'},{n:'Pearl',h:'#ffffff'},
  {n:'Sky',h:'#3a93cf'},{n:'Midnight',h:'#14364d'},{n:'Flax',h:'#eedc82'},{n:'Chartreuse',h:'#c6e005'},
];
const MERGE={
  Contact:['{{ contact.firstname }}','{{ contact.lastname }}','{{ contact.email }}','{{ contact.company }}','{{ contact.jobtitle }}'],
  Sender:['{{ sender.firstname }}','{{ sender.lastname }}','{{ sender.email }}','{{ owner.name }}'],
  Links:['{{ unsubscribe_link }}','{{ view_in_browser_link }}'],
};

// ── BLOCK DEFINITIONS ────────────────────────────────────────────────────────
const BD={
  heading:{
    label:'Heading', icon:'H',
    defaults:{text:'Your heading here',size:'large',align:'left'},
    fieldDefs:[
      {k:'text',l:'Text',t:'input'},
      {k:'size',l:'Size',t:'select',opts:['large','medium','small']},
      {k:'align',l:'Align',t:'select',opts:['left','center','right']},
    ],
    render(f,frame){
      const sz={large:'36px',medium:'26px',small:'20px'}[f.size]||'36px';
      const wt={large:'400',medium:'700',small:'700'}[f.size]||'400';
      const ff_={large:"Georgia,'Times New Roman',serif",medium:'Arial,sans-serif',small:'Arial,sans-serif'}[f.size]||"Georgia,serif";
      return `<tr><td style="background:#ffffff;padding:32px 36px 8px;text-align:${f.align||'left'};">
        <h2 style="margin:0;font-family:${ff_};font-size:${sz};line-height:1.2;color:#0a0a0a;font-weight:${wt};">${f.text}</h2>
      </td></tr>`;
    }
  },
  text:{
    label:'Text', icon:'P',
    defaults:{text:'Your paragraph text goes here. Write something compelling.'},
    fieldDefs:[{k:'text',l:'Paragraph',t:'textarea'}],
    render(f,frame){
      return `<tr><td style="background:#ffffff;padding:12px 36px 20px;">
        <p style="margin:0;font-family:Georgia,'Times New Roman',serif;font-size:16px;line-height:1.85;color:#1c1c1c;">${f.text}</p>
      </td></tr>`;
    }
  },
  image:{
    label:'Image', icon:'I',
    defaults:{src:'',alt:'',w:'100',align:'center'},
    fieldDefs:[
      {k:'src',l:'Image',t:'image'},
      {k:'alt',l:'Alt Text',t:'input'},
      {k:'w',l:'Width',t:'widthbtns'},
      {k:'align',l:'Align',t:'alignbtns'},
    ],
    render(f,frame){
      const maxW=528, px=Math.round(maxW*parseInt(f.w||'100')/100);
      const ml=f.align==='right'?'auto':f.align==='left'?'0':'auto';
      const mr=f.align==='right'?'0':f.align==='left'?'auto':'auto';
      const img=f.src
        ?`<img src="${f.src}" alt="${f.alt||''}" width="${px}" style="display:block;width:100%;max-width:${px}px;height:auto;border:0;margin-left:${ml};margin-right:${mr};">`
        :`<table border="0" cellpadding="0" cellspacing="0" width="${px}"><tr><td style="height:${Math.round(px*.55)}px;background:#E8E8E6;text-align:center;vertical-align:middle;"><p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:#bbb;letter-spacing:1px;text-transform:uppercase;">Image</p></td></tr></table>`;
      return `<tr><td style="background:#ffffff;padding:16px 36px;">${img}</td></tr>`;
    }
  },
  img_text:{
    label:'Image + Text', icon:'IT',
    defaults:{src:'',alt:'',side:'left',text:'Pair an image with compelling body copy. Great for showcasing a feature, person, or visual concept alongside context.'},
    fieldDefs:[
      {k:'src',l:'Image',t:'image'},
      {k:'alt',l:'Alt Text',t:'input'},
      {k:'side',l:'Image Side',t:'select',opts:['left','right']},
      {k:'text',l:'Text',t:'textarea'},
    ],
    render(f,frame){
      const imgW=220;
      const img=f.src
        ?`<img src="${f.src}" alt="${f.alt||''}" width="${imgW}" style="display:block;width:${imgW}px;height:auto;border:0;">`
        :`<table border="0" cellpadding="0" cellspacing="0" width="${imgW}"><tr><td style="height:160px;background:#E8E8E6;text-align:center;vertical-align:middle;"><p style="margin:0;font-family:Arial,sans-serif;font-size:9px;color:#bbb;letter-spacing:1px;text-transform:uppercase;">Image</p></td></tr></table>`;
      const imgCell=`<td valign="top" width="${imgW}" style="padding-${f.side==='left'?'right':'left'}:20px;">${img}</td>`;
      const txtCell=`<td valign="top"><p style="margin:0;font-family:Georgia,serif;font-size:15px;line-height:1.8;color:#1c1c1c;">${f.text}</p></td>`;
      return `<tr><td style="background:#ffffff;padding:20px 36px;">
        <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
          ${f.side==='left'?imgCell+txtCell:txtCell+imgCell}
        </tr></table>
      </td></tr>`;
    }
  },
  cta:{
    label:'CTA Button', icon:'CTA',
    defaults:{label:'Learn More',url:'https://rankings.io',align:'left'},
    fieldDefs:[
      {k:'label',l:'Button Text',t:'input'},
      {k:'url',l:'URL',t:'input'},
      {k:'align',l:'Alignment',t:'select',opts:['left','center','right']},
    ],
    render(f,frame){
      const color=frame.color_cta||'#0A0A0A';
      const td_align=f.align||'left';
      return `<tr><td style="background:#ffffff;padding:12px 36px 24px;" align="${td_align}">
        <table border="0" cellpadding="0" cellspacing="0" style="display:inline-table;"><tr><td style="background:${color};">
          <a href="${f.url}" style="display:inline-block;padding:14px 28px;font-family:Arial,sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#ffffff;text-decoration:none;">${f.label}</a>
        </td></tr></table>
      </td></tr>`;
    }
  },
  quote:{
    label:'Pull Quote', icon:'"',
    defaults:{text:'The insight that changed everything about how we thought about this problem.'},
    fieldDefs:[{k:'text',l:'Quote Text',t:'textarea'}],
    render(f,frame){
      const color=frame.color_cta||'#C8391A';
      return `<tr><td style="background:#ffffff;padding:8px 36px 24px;">
        <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
          <td style="border-left:4px solid ${color};padding:16px 20px;background:#F7F6F2;">
            <p style="margin:0;font-family:Georgia,serif;font-size:18px;line-height:1.65;color:#0a0a0a;font-style:italic;">\u201c${f.text}\u201d</p>
          </td>
        </tr></table>
      </td></tr>`;
    }
  },
  stats:{
    label:'Stats Row', icon:'123',
    defaults:{s1_val:'+240%',s1_label:'Organic Traffic',s2_val:'4x',s2_label:'Lead Volume',s3_val:'87',s3_label:'Page 1 Keywords'},
    fieldDefs:[
      {k:'s1_val',l:'Stat 1 Value',t:'input'},{k:'s1_label',l:'Stat 1 Label',t:'input'},
      {k:'s2_val',l:'Stat 2 Value',t:'input'},{k:'s2_label',l:'Stat 2 Label',t:'input'},
      {k:'s3_val',l:'Stat 3 Value',t:'input'},{k:'s3_label',l:'Stat 3 Label',t:'input'},
    ],
    render(f,frame){
      const color=frame.color_cta||'#C8391A';
      return `<tr><td style="background:#ffffff;padding:20px 36px 24px;">
        <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
          ${[['s1','left'],['s2','center'],['s3','right']].map(([k,a])=>`
          <td align="${a}" style="width:33%;padding:16px 6px;background:#F5F4F0;text-align:center;">
            <p style="margin:0 0 4px;font-family:'Arial Black',Arial,sans-serif;font-size:28px;font-weight:900;color:${color};">${f[k+'_val']}</p>
            <p style="margin:0;font-family:Arial,sans-serif;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:#888;">${f[k+'_label']}</p>
          </td>`).join('')}
        </tr></table>
      </td></tr>`;
    }
  },
  three_col:{
    label:'3-Col Cards', icon:'|||',
    defaults:{
      c1_src:'',c1_title:'Card One',c1_desc:'Short description for this card item goes here.',
      c2_src:'',c2_title:'Card Two',c2_desc:'Short description for this card item goes here.',
      c3_src:'',c3_title:'Card Three',c3_desc:'Short description for this card item goes here.',
    },
    fieldDefs:[
      {k:'c1_src',l:'Card 1 Image',t:'image'},{k:'c1_title',l:'Card 1 Title',t:'input'},{k:'c1_desc',l:'Card 1 Desc',t:'textarea'},
      {k:'c2_src',l:'Card 2 Image',t:'image'},{k:'c2_title',l:'Card 2 Title',t:'input'},{k:'c2_desc',l:'Card 2 Desc',t:'textarea'},
      {k:'c3_src',l:'Card 3 Image',t:'image'},{k:'c3_title',l:'Card 3 Title',t:'input'},{k:'c3_desc',l:'Card 3 Desc',t:'textarea'},
    ],
    render(f,frame){
      const color=frame.color_cta||'#0A0A0A';
      const card=(src,title,desc,pad)=>{
        const img=src?`<img src="${src}" alt="" width="155" style="display:block;width:155px;height:auto;border:0;">`
          :`<table border="0" cellpadding="0" cellspacing="0" width="155"><tr><td style="height:110px;background:#E8E8E6;text-align:center;vertical-align:middle;"><p style="margin:0;font-family:Arial,sans-serif;font-size:8px;color:#bbb;letter-spacing:1px;text-transform:uppercase;">Image</p></td></tr></table>`;
        return `<td valign="top" width="173" style="padding:0 ${pad};">${img}
          <p style="margin:10px 0 5px;font-family:Arial,sans-serif;font-size:13px;font-weight:700;color:#0a0a0a;line-height:1.3;">${title}</p>
          <p style="margin:0;font-family:Arial,sans-serif;font-size:12px;line-height:1.6;color:#666;">${desc}</p>
        </td>`;
      };
      return `<tr><td style="background:#ffffff;padding:20px 28px 28px;">
        <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
          ${card(f.c1_src,f.c1_title,f.c1_desc,'0 9px 0 0')}
          ${card(f.c2_src,f.c2_title,f.c2_desc,'0 4px')}
          ${card(f.c3_src,f.c3_title,f.c3_desc,'0 0 0 9px')}
        </tr></table>
      </td></tr>`;
    }
  },
  two_col:{
    label:'2-Col Images', icon:'||',
    defaults:{
      left_src:'',left_caption:'Caption for the left image.',
      right_src:'',right_caption:'Caption for the right image.',
    },
    fieldDefs:[
      {k:'left_src',l:'Left Image',t:'image'},{k:'left_caption',l:'Left Caption',t:'input'},
      {k:'right_src',l:'Right Image',t:'image'},{k:'right_caption',l:'Right Caption',t:'input'},
    ],
    render(f,frame){
      const col=(src,cap,pad)=>{
        const img=src?`<img src="${src}" alt="" width="252" style="display:block;width:252px;height:auto;border:0;">`
          :`<table border="0" cellpadding="0" cellspacing="0" width="252"><tr><td style="height:170px;background:#E8E8E6;text-align:center;vertical-align:middle;"><p style="margin:0;font-family:Arial,sans-serif;font-size:9px;color:#bbb;letter-spacing:1px;text-transform:uppercase;">Image</p></td></tr></table>`;
        return `<td valign="top" width="264" style="padding:0 ${pad};">${img}
          <p style="margin:8px 0 0;font-family:Georgia,serif;font-size:12px;line-height:1.6;color:#666;">${cap}</p>
        </td>`;
      };
      return `<tr><td style="background:#ffffff;padding:16px 36px 24px;">
        <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
          ${col(f.left_src,f.left_caption,'0 12px 0 0')}
          ${col(f.right_src,f.right_caption,'0 0 0 12px')}
        </tr></table>
      </td></tr>`;
    }
  },
  callout:{
    label:'Callout Box', icon:'!',
    defaults:{text:'A key point, announcement, or highlight that deserves its own visual emphasis.',bg:'#F0F7FF',border:'#3a93cf'},
    fieldDefs:[
      {k:'text',l:'Content',t:'textarea'},
      {k:'bg',l:'Background',t:'color'},
      {k:'border',l:'Border Color',t:'color'},
    ],
    render(f,frame){
      return `<tr><td style="background:#ffffff;padding:8px 36px 16px;">
        <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
          <td style="background:${f.bg||'#F0F7FF'};border-left:4px solid ${f.border||'#3a93cf'};padding:16px 20px;">
            <p style="margin:0;font-family:Georgia,serif;font-size:15px;line-height:1.75;color:#1c1c1c;">${f.text}</p>
          </td>
        </tr></table>
      </td></tr>`;
    }
  },
  divider:{
    label:'Divider', icon:'—',
    defaults:{color:'#E4E4E4',spacing:'16'},
    fieldDefs:[
      {k:'color',l:'Line Color',t:'color'},
      {k:'spacing',l:'Padding (px)',t:'input'},
    ],
    render(f,frame){
      const sp=parseInt(f.spacing||'16');
      return `<tr><td style="background:#ffffff;padding:${sp}px 36px;">
        <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td style="height:1px;background:${f.color||'#E4E4E4'};font-size:0;">&nbsp;</td></tr></table>
      </td></tr>`;
    }
  },
  spacer:{
    label:'Spacer', icon:'↕',
    defaults:{height:'32',bg:'#ffffff'},
    fieldDefs:[
      {k:'height',l:'Height (px)',t:'input'},
      {k:'bg',l:'Background',t:'color'},
    ],
    render(f,frame){
      return `<tr><td style="height:${parseInt(f.height||'32')}px;background:${f.bg||'#ffffff'};font-size:0;line-height:0;">&nbsp;</td></tr>`;
    }
  },
};

// ── FRAME FIELD LABELS ────────────────────────────────────────────────────────
const FL={
  logo_text:'Brand / Logo',pre_header:'Preheader Text',issue_label:'Issue Label',
  color_header:'Header Color',color_cta:'Accent / CTA Color',color_bg:'Background Color',
  footer_co:'Footer Company',footer_addr:'Footer Address',
  eyebrow:'Eyebrow Label',
  company:'Company',greeting:'Greeting',p1:'Paragraph 1',p2:'Paragraph 2',p3:'Closing Ask',
  signoff:'Sign-Off',sender_name:'Your Name',sender_title:'Your Title',sender_email:'Your Email',
  ps:'P.S. Line',context_note:'Context Note',ask:'Ask',color_accent:'Accent Color',
};
const FTA=new Set(['p1','p2','p3','ask','ps']);
const FCOL=new Set(['color_header','color_cta','color_bg','color_accent']);

// ── FRAMES ────────────────────────────────────────────────────────────────────
// Each frame: frameFields[], frameDefaults{}, defaultBlocks[], renderOpen(ff), renderClose(ff)
const EH=`<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml">`;
const EM=`<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head>`;

const FRAMES={
marketing:{

dispatch:{
  label:'The Dispatch',
  frameFields:['logo_text','pre_header','issue_label','color_header','color_cta','footer_co','footer_addr'],
  frameDefaults:{logo_text:'RANKINGS.IO',pre_header:'Your weekly edge in legal marketing.',issue_label:'Issue No. 12 — Feb 2026',color_header:'#0A0A0A',color_cta:'#C8391A',footer_co:'Rankings.io',footer_addr:'123 Main St, Salt Lake City, UT 84101'},
  defaultBlocks:[
    {id:'b1',type:'heading',fields:{text:'The one thing your competitors are doing that you\u2019re not.',size:'large',align:'left'}},
    {id:'b2',type:'text',fields:{text:'Most law firms treat their website like a billboard. Set it, forget it, hope for the best. But the firms outpacing you are doing something different.'}},
    {id:'b3',type:'image',fields:{src:'',alt:'',w:'100',align:'center'}},
    {id:'b4',type:'text',fields:{text:'They\u2019re treating their digital presence like a product \u2014 shipping updates, testing ideas, measuring what moves the needle. It\u2019s not glamorous. But it compounds.'}},
    {id:'b5',type:'quote',fields:{text:'The best SEO strategy isn\u2019t the most complex one. It\u2019s the one that actually gets executed.'}},
    {id:'b6',type:'cta',fields:{label:'Read the Full Brief \u2192',url:'https://rankings.io',align:'left'}},
  ],
  renderOpen(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:#EDECE8;font-family:Georgia,serif;">
<div style="display:none;max-height:0;overflow:hidden;">${ff.pre_header}</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:#EDECE8;"><tr><td align="center" style="padding:28px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="600">
<tr><td style="background:${ff.color_header};padding:18px 28px;">
  <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
    <td style="font-family:'Arial Black',Arial,sans-serif;font-size:11px;font-weight:900;letter-spacing:4px;color:#fff;text-transform:uppercase;">${ff.logo_text}</td>
    <td align="right" style="font-family:Arial,sans-serif;font-size:9px;letter-spacing:2px;color:#666;text-transform:uppercase;">${ff.issue_label}</td>
  </tr></table>
</td></tr>`;
  },
  renderClose(ff){
    return `<tr><td style="background:${ff.color_header};height:3px;font-size:0;">&nbsp;</td></tr>
<tr><td style="padding:20px 36px;background:#EDECE8;">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:11px;color:#aaa;line-height:1.7;"><strong style="color:#888;">${ff.footer_co}</strong><br>${ff.footer_addr}<br><br>
  <a href="{{ unsubscribe_link }}" style="color:#aaa;">Unsubscribe</a> &middot; <a href="{{ view_in_browser_link }}" style="color:#aaa;">View in browser</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

spotlight:{
  label:'Feature Spotlight',
  frameFields:['logo_text','pre_header','color_header','color_cta','footer_co','footer_addr'],
  frameDefaults:{logo_text:'RANKINGS.IO',pre_header:'Something new just dropped.',color_header:'#0A0A0A',color_cta:'#1D4ED8',footer_co:'Rankings.io',footer_addr:'123 Main St, Salt Lake City, UT 84101'},
  defaultBlocks:[
    {id:'b1',type:'image',fields:{src:'',alt:'Hero image',w:'100',align:'center'}},
    {id:'b2',type:'heading',fields:{text:'Track rankings that actually mean something.',size:'large',align:'left'}},
    {id:'b3',type:'text',fields:{text:'We rebuilt our rank tracking engine from the ground up. More data points, faster updates, and a view of what\u2019s moving \u2014 and more importantly, what\u2019s not.'}},
    {id:'b4',type:'three_col',fields:{c1_src:'',c1_title:'Daily Updates',c1_desc:'See how you moved overnight.',c2_src:'',c2_title:'Competitor Delta',c2_desc:'Know when rivals jump ahead.',c3_src:'',c3_title:'Local Splits',c3_desc:'City and state performance.'}},
    {id:'b5',type:'cta',fields:{label:'See It in Action',url:'https://rankings.io',align:'left'}},
  ],
  renderOpen(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:#F2F2F2;font-family:Arial,sans-serif;">
<div style="display:none;max-height:0;overflow:hidden;">${ff.pre_header}</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:#F2F2F2;"><tr><td align="center" style="padding:28px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="600">
<tr><td style="background:${ff.color_header};height:4px;font-size:0;">&nbsp;</td></tr>
<tr><td style="background:#fff;padding:20px 32px 22px;border-bottom:1px solid #eee;">
  <p style="margin:0;font-family:'Arial Black',Arial,sans-serif;font-size:11px;font-weight:900;letter-spacing:4px;color:${ff.color_header};text-transform:uppercase;">${ff.logo_text}</p>
</td></tr>`;
  },
  renderClose(ff){
    return `<tr><td style="background:${ff.color_header};height:3px;font-size:0;">&nbsp;</td></tr>
<tr><td style="padding:18px 32px;background:#F2F2F2;">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:11px;color:#aaa;line-height:1.7;"><strong style="color:#888;">${ff.footer_co}</strong> &middot; ${ff.footer_addr}<br>
  <a href="{{ unsubscribe_link }}" style="color:#aaa;">Unsubscribe</a> &middot; <a href="{{ view_in_browser_link }}" style="color:#aaa;">View in browser</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

cover_story:{
  label:'Cover Story',
  frameFields:['logo_text','pre_header','eyebrow','color_header','color_cta','footer_co','footer_addr'],
  frameDefaults:{logo_text:'RANKINGS.IO',pre_header:'Inside this issue.',eyebrow:'Deep Dive',color_header:'#282828',color_cta:'#C8391A',footer_co:'Rankings.io',footer_addr:'123 Main St, Salt Lake City, UT 84101'},
  defaultBlocks:[
    {id:'b1',type:'image',fields:{src:'',alt:'Cover image',w:'100',align:'center'}},
    {id:'b2',type:'heading',fields:{text:'Why the best law firm sites are built like media companies.',size:'large',align:'left'}},
    {id:'b3',type:'img_text',fields:{src:'',alt:'',side:'left',text:'The firms ranking on page one for competitive terms aren\u2019t winning by accident. They\u2019ve made a structural decision to treat content as infrastructure \u2014 and it shows.'}},
    {id:'b4',type:'text',fields:{text:'What that means in practice: regular publishing cadence, a clear topical authority strategy, and a site architecture that search engines can actually crawl and understand.'}},
    {id:'b5',type:'cta',fields:{label:'Read the Full Story',url:'https://rankings.io',align:'left'}},
  ],
  renderOpen(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:#EDE8DF;font-family:Georgia,serif;">
<div style="display:none;max-height:0;overflow:hidden;">${ff.pre_header}</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:#EDE8DF;"><tr><td align="center" style="padding:28px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="600">
<tr><td style="background:${ff.color_header};padding:16px 28px;">
  <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
    <td style="font-family:'Arial Black',Arial,sans-serif;font-size:12px;font-weight:900;letter-spacing:3px;color:#fff;text-transform:uppercase;">${ff.logo_text}</td>
    <td align="right"><p style="margin:0;font-family:Arial,sans-serif;font-size:9px;letter-spacing:2px;color:#888;text-transform:uppercase;">${ff.eyebrow}</p></td>
  </tr></table>
</td></tr>`;
  },
  renderClose(ff){
    return `<tr><td style="background:${ff.color_header};height:3px;font-size:0;">&nbsp;</td></tr>
<tr><td style="padding:18px 28px;background:#EDE8DF;">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:#aaa;line-height:1.7;"><strong style="color:#888;">${ff.footer_co}</strong> &middot; ${ff.footer_addr}<br>
  <a href="{{ unsubscribe_link }}" style="color:#aaa;">Unsubscribe</a> &middot; <a href="{{ view_in_browser_link }}" style="color:#aaa;">View in browser</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

showcase_row:{
  label:'Showcase Row',
  frameFields:['logo_text','pre_header','color_bg','color_cta','footer_co','footer_addr'],
  frameDefaults:{logo_text:'RANKINGS.IO',pre_header:'Three things worth your attention.',color_bg:'#14364d',color_cta:'#c6e005',footer_co:'Rankings.io',footer_addr:'123 Main St, Salt Lake City, UT 84101'},
  defaultBlocks:[
    {id:'b1',type:'heading',fields:{text:'This week in legal SEO.',size:'large',align:'left'}},
    {id:'b2',type:'text',fields:{text:'Three reads, insights, and ideas curated by the Rankings.io team.'}},
    {id:'b3',type:'three_col',fields:{c1_src:'',c1_title:'The Content Flywheel',c1_desc:'How one article a week compounds into 10x traffic over 18 months.',c2_src:'',c2_title:'Local Pack Domination',c2_desc:'The exact playbook for 40-city map pack coverage.',c3_src:'',c3_title:'Technical SEO Checklist',c3_desc:'12 things we check before touching any content.'}},
    {id:'b4',type:'cta',fields:{label:'Read All Three',url:'https://rankings.io',align:'left'}},
  ],
  renderOpen(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:${ff.color_bg};font-family:Arial,sans-serif;">
<div style="display:none;max-height:0;overflow:hidden;">${ff.pre_header}</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:${ff.color_bg};"><tr><td align="center" style="padding:28px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="600">
<tr><td style="padding:22px 28px;border-bottom:1px solid rgba(255,255,255,.1);">
  <p style="margin:0;font-family:'Arial Black',Arial,sans-serif;font-size:11px;font-weight:900;letter-spacing:4px;color:${ff.color_cta};text-transform:uppercase;">${ff.logo_text}</p>
</td></tr>`;
  },
  renderClose(ff){
    return `<tr><td style="padding:20px 28px;border-top:1px solid rgba(255,255,255,.1);">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:rgba(255,255,255,.3);line-height:1.7;"><strong style="color:rgba(255,255,255,.5);">${ff.footer_co}</strong> &middot; ${ff.footer_addr}<br>
  <a href="{{ unsubscribe_link }}" style="color:rgba(255,255,255,.3);">Unsubscribe</a> &middot; <a href="{{ view_in_browser_link }}" style="color:rgba(255,255,255,.3);">View in browser</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

dark_brief:{
  label:'Dark Brief',
  frameFields:['logo_text','pre_header','color_cta','footer_co','footer_addr'],
  frameDefaults:{logo_text:'RANKINGS.IO',pre_header:'Read this before your next meeting.',color_cta:'#c6e005',footer_co:'Rankings.io',footer_addr:'123 Main St, Salt Lake City, UT 84101'},
  defaultBlocks:[
    {id:'b1',type:'image',fields:{src:'',alt:'Hero image',w:'100',align:'center'}},
    {id:'b2',type:'heading',fields:{text:'Your firm\u2019s biggest competitor isn\u2019t another law firm.',size:'large',align:'left'}},
    {id:'b3',type:'text',fields:{text:'It\u2019s the Google search result above you. The one getting the click before your name even registers. Every day that position belongs to someone else is a day your phone doesn\u2019t ring.'}},
    {id:'b4',type:'text',fields:{text:'We built Rankings.io to fix exactly this. Not with shortcuts. With methodology that compounds over time and produces durable, defensible positions.'}},
    {id:'b5',type:'cta',fields:{label:'See How It Works',url:'https://rankings.io',align:'left'}},
  ],
  renderOpen(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:#141414;font-family:Georgia,serif;">
<div style="display:none;max-height:0;overflow:hidden;">${ff.pre_header}</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:#141414;"><tr><td align="center" style="padding:28px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="600">
<tr><td style="padding:20px 28px;border-bottom:1px solid #222;">
  <p style="margin:0;font-family:'Arial Black',Arial,sans-serif;font-size:11px;font-weight:900;letter-spacing:4px;color:${ff.color_cta};text-transform:uppercase;">${ff.logo_text}</p>
</td></tr>`;
  },
  renderClose(ff){
    return `<tr><td style="padding:20px 32px;border-top:1px solid #222;">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:#444;line-height:1.7;"><strong style="color:#555;">${ff.footer_co}</strong> &middot; ${ff.footer_addr}<br>
  <a href="{{ unsubscribe_link }}" style="color:#444;">Unsubscribe</a> &middot; <a href="{{ view_in_browser_link }}" style="color:#444;">View in browser</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

case_study:{
  label:'Case Study',
  frameFields:['logo_text','pre_header','color_header','color_cta','footer_co','footer_addr'],
  frameDefaults:{logo_text:'RANKINGS.IO',pre_header:'A real result from a real client.',color_header:'#0A0A0A',color_cta:'#C8391A',footer_co:'Rankings.io',footer_addr:'123 Main St, Salt Lake City, UT 84101'},
  defaultBlocks:[
    {id:'b1',type:'image',fields:{src:'',alt:'Case study banner',w:'100',align:'center'}},
    {id:'b2',type:'heading',fields:{text:'From page 4 to page 1 in 6 months.',size:'large',align:'left'}},
    {id:'b3',type:'stats',fields:{s1_val:'+310%',s1_label:'Organic Traffic',s2_val:'4x',s2_label:'Lead Volume',s3_val:'87',s3_label:'Page 1 Keywords'}},
    {id:'b4',type:'text',fields:{text:'When Thompson & Associates came to us, they were spending $12k/month on paid search and getting almost nothing from organic. Six months later, organic is their #1 lead source.'}},
    {id:'b5',type:'cta',fields:{label:'Read the Full Case Study',url:'https://rankings.io',align:'left'}},
  ],
  renderOpen(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:#F5F4F0;font-family:Arial,sans-serif;">
<div style="display:none;max-height:0;overflow:hidden;">${ff.pre_header}</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:#F5F4F0;"><tr><td align="center" style="padding:28px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="600">
<tr><td style="background:${ff.color_header};padding:18px 28px;">
  <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
    <td style="font-family:'Arial Black',Arial,sans-serif;font-size:11px;font-weight:900;letter-spacing:4px;color:#fff;text-transform:uppercase;">${ff.logo_text}</td>
    <td align="right" style="font-family:Arial,sans-serif;font-size:9px;letter-spacing:1.5px;color:#888;text-transform:uppercase;">Case Study</td>
  </tr></table>
</td></tr>`;
  },
  renderClose(ff){
    return `<tr><td style="background:${ff.color_header};height:3px;font-size:0;">&nbsp;</td></tr>
<tr><td style="padding:18px 28px;background:#F5F4F0;">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:#aaa;line-height:1.7;"><strong style="color:#888;">${ff.footer_co}</strong> &middot; ${ff.footer_addr}<br>
  <a href="{{ unsubscribe_link }}" style="color:#aaa;">Unsubscribe</a> &middot; <a href="{{ view_in_browser_link }}" style="color:#aaa;">View in browser</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

event_invite:{
  label:'Event Invite',
  frameFields:['logo_text','pre_header','color_header','color_cta','footer_co','footer_addr'],
  frameDefaults:{logo_text:'RANKINGS.IO',pre_header:'You\u2019re invited.',color_header:'#14364d',color_cta:'#3a93cf',footer_co:'Rankings.io',footer_addr:'123 Main St, Salt Lake City, UT 84101'},
  defaultBlocks:[
    {id:'b1',type:'image',fields:{src:'',alt:'Event banner',w:'100',align:'center'}},
    {id:'b2',type:'heading',fields:{text:'The Legal Marketing Summit — March 18, 2026',size:'large',align:'left'}},
    {id:'b3',type:'stats',fields:{s1_val:'Mar 18',s1_label:'Date',s2_val:'2pm ET',s2_label:'Time',s3_val:'Virtual',s3_label:'Format'}},
    {id:'b4',type:'text',fields:{text:'Join us for an afternoon of straight talk on what\u2019s actually working in legal marketing right now. No sponsored content. No vendor pitches. Just data and strategy.'}},
    {id:'b5',type:'img_text',fields:{src:'',alt:'Speaker photo',side:'left',text:'Chris Dreyer — CEO, Rankings.io\n\nChris has spent a decade helping law firms win on Google. He\u2019ll break down the exact strategies top firms are using heading into 2026.'}},
    {id:'b6',type:'cta',fields:{label:'Reserve Your Spot',url:'https://rankings.io',align:'center'}},
  ],
  renderOpen(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:#f5f5f3;font-family:Arial,sans-serif;">
<div style="display:none;max-height:0;overflow:hidden;">${ff.pre_header}</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:#f5f5f3;"><tr><td align="center" style="padding:28px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="600">
<tr><td style="background:#fff;padding:18px 28px;border-bottom:1px solid #eee;">
  <p style="margin:0;font-family:'Arial Black',Arial,sans-serif;font-size:11px;font-weight:900;letter-spacing:4px;color:${ff.color_header};text-transform:uppercase;">${ff.logo_text}</p>
</td></tr>`;
  },
  renderClose(ff){
    return `<tr><td style="padding:18px 28px;background:#f5f5f3;">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:#aaa;line-height:1.7;"><strong style="color:#888;">${ff.footer_co}</strong> &middot; ${ff.footer_addr}<br>
  <a href="{{ unsubscribe_link }}" style="color:#aaa;">Unsubscribe</a> &middot; <a href="{{ view_in_browser_link }}" style="color:#aaa;">View in browser</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

the_grid:{
  label:'The Grid',
  frameFields:['logo_text','pre_header','color_header','color_cta','footer_co','footer_addr'],
  frameDefaults:{logo_text:'RANKINGS.IO',pre_header:'Four stories, four images.',color_header:'#0A0A0A',color_cta:'#3a93cf',footer_co:'Rankings.io',footer_addr:'123 Main St, Salt Lake City, UT 84101'},
  defaultBlocks:[
    {id:'b1',type:'heading',fields:{text:'The week in legal marketing.',size:'medium',align:'left'}},
    {id:'b2',type:'two_col',fields:{left_src:'',left_caption:'Google\u2019s algo update hit 40% of legal sites. Here\u2019s what changed.',right_src:'',right_caption:'The anatomy of a page-one PI landing page in 2026.'}},
    {id:'b3',type:'two_col',fields:{left_src:'',left_caption:'Why your Google Business Profile is your most underutilized asset.',right_src:'',right_caption:'Three law firms that doubled leads without increasing ad spend.'}},
    {id:'b4',type:'cta',fields:{label:'Read All Stories',url:'https://rankings.io',align:'left'}},
  ],
  renderOpen(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:#ffffff;font-family:Arial,sans-serif;">
<div style="display:none;max-height:0;overflow:hidden;">${ff.pre_header}</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:#fff;"><tr><td align="center" style="padding:28px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="600">
<tr><td style="background:${ff.color_header};padding:18px 28px;">
  <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
    <td style="font-family:'Arial Black',Arial,sans-serif;font-size:11px;font-weight:900;letter-spacing:4px;color:#fff;text-transform:uppercase;">${ff.logo_text}</td>
    <td align="right" style="font-family:Arial,sans-serif;font-size:9px;letter-spacing:2px;color:#888;text-transform:uppercase;">The Grid</td>
  </tr></table>
</td></tr>`;
  },
  renderClose(ff){
    return `<tr><td style="background:${ff.color_header};height:3px;font-size:0;">&nbsp;</td></tr>
<tr><td style="padding:18px 28px;background:#f8f8f8;">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:#aaa;line-height:1.7;"><strong style="color:#888;">${ff.footer_co}</strong> &middot; ${ff.footer_addr}<br>
  <a href="{{ unsubscribe_link }}" style="color:#aaa;">Unsubscribe</a> &middot; <a href="{{ view_in_browser_link }}" style="color:#aaa;">View in browser</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

bold_drop:{
  label:'Bold Drop',
  frameFields:['logo_text','pre_header','color_bg','color_cta','footer_co','footer_addr'],
  frameDefaults:{logo_text:'RANKINGS.IO',pre_header:'New from Rankings.io.',color_bg:'#EEDC82',color_cta:'#282828',footer_co:'Rankings.io',footer_addr:'123 Main St, Salt Lake City, UT 84101'},
  defaultBlocks:[
    {id:'b1',type:'heading',fields:{text:'Three tools we\u2019re shipping this quarter.',size:'large',align:'left'}},
    {id:'b2',type:'text',fields:{text:'We\u2019ve been heads down building. Here\u2019s what\u2019s coming out of the lab and into your dashboard.'}},
    {id:'b3',type:'image',fields:{src:'',alt:'Product image',w:'100',align:'center'}},
    {id:'b4',type:'three_col',fields:{c1_src:'',c1_title:'Rank Intelligence',c1_desc:'Daily position tracking with competitor alerts.',c2_src:'',c2_title:'Content Radar',c2_desc:'Find content gaps before competitors do.',c3_src:'',c3_title:'Lead Decoder',c3_desc:'Tie rankings directly to phone calls.'}},
    {id:'b5',type:'cta',fields:{label:'Get Early Access',url:'https://rankings.io',align:'left'}},
  ],
  renderOpen(ff){
    const bg=ff.color_bg||'#EEDC82';
    return `${EH}${EM}<body style="margin:0;padding:0;background:${bg};font-family:Arial,sans-serif;">
<div style="display:none;max-height:0;overflow:hidden;">${ff.pre_header}</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:${bg};"><tr><td align="center" style="padding:28px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="600">
<tr><td style="padding:20px 28px;border-bottom:2px solid rgba(0,0,0,.12);">
  <p style="margin:0;font-family:'Arial Black',Arial,sans-serif;font-size:11px;font-weight:900;letter-spacing:4px;color:#0a0a0a;text-transform:uppercase;">${ff.logo_text}</p>
</td></tr>`;
  },
  renderClose(ff){
    const bg=ff.color_bg||'#EEDC82';
    return `<tr><td style="padding:18px 28px;border-top:2px solid rgba(0,0,0,.12);background:${bg};">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:rgba(0,0,0,.45);line-height:1.7;"><strong style="color:rgba(0,0,0,.6);">${ff.footer_co}</strong> &middot; ${ff.footer_addr}<br>
  <a href="{{ unsubscribe_link }}" style="color:rgba(0,0,0,.45);">Unsubscribe</a> &middot; <a href="{{ view_in_browser_link }}" style="color:rgba(0,0,0,.45);">View in browser</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

the_studio:{
  label:'The Studio',
  frameFields:['logo_text','pre_header','color_cta','footer_co','footer_addr'],
  frameDefaults:{logo_text:'RANKINGS.IO',pre_header:'Work that speaks.',color_cta:'#0A0A0A',footer_co:'Rankings.io',footer_addr:'123 Main St, Salt Lake City, UT 84101'},
  defaultBlocks:[
    {id:'b1',type:'image',fields:{src:'',alt:'Studio hero',w:'100',align:'center'}},
    {id:'b2',type:'heading',fields:{text:'What exceptional legal marketing looks like.',size:'large',align:'left'}},
    {id:'b3',type:'img_text',fields:{src:'',alt:'Feature image',side:'right',text:'Every firm we work with starts in the same place: invisible on search. What changes is the work that happens next. The audit, the strategy, the execution, the iteration.'}},
    {id:'b4',type:'text',fields:{text:'We don\u2019t take shortcuts. We don\u2019t sell packages. We build systems that outlast any single algorithm update.'}},
    {id:'b5',type:'cta',fields:{label:'See Our Work',url:'https://rankings.io',align:'left'}},
  ],
  renderOpen(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:#ffffff;font-family:Arial,sans-serif;">
<div style="display:none;max-height:0;overflow:hidden;">${ff.pre_header}</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:#fff;"><tr><td align="center" style="padding:28px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="600">
<tr><td style="background:#0a0a0a;padding:20px 28px;">
  <table border="0" cellpadding="0" cellspacing="0" width="100%"><tr>
    <td style="font-family:'Arial Black',Arial,sans-serif;font-size:11px;font-weight:900;letter-spacing:4px;color:#fff;text-transform:uppercase;">${ff.logo_text}</td>
    <td align="right" style="font-family:Arial,sans-serif;font-size:9px;letter-spacing:2px;color:#444;text-transform:uppercase;">Studio</td>
  </tr></table>
</td></tr>`;
  },
  renderClose(ff){
    return `<tr><td style="background:#0a0a0a;height:3px;font-size:0;">&nbsp;</td></tr>
<tr><td style="padding:18px 28px;background:#f8f8f8;">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:#aaa;line-height:1.7;"><strong style="color:#888;">${ff.footer_co}</strong> &middot; ${ff.footer_addr}<br>
  <a href="{{ unsubscribe_link }}" style="color:#aaa;">Unsubscribe</a> &middot; <a href="{{ view_in_browser_link }}" style="color:#aaa;">View in browser</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

},// end marketing

sales:{

outreach:{
  label:'Personal Outreach',
  frameFields:['company','greeting','p1','p2','p3','signoff','sender_name','sender_title','sender_email','ps','color_accent'],
  frameDefaults:{company:'Rankings.io',greeting:'Hi {{ contact.firstname }},',
    p1:'I came across {{ contact.company }} and noticed you\u2019ve been building a real presence in your market. Most law firms your size are leaving a significant amount of organic search traffic on the table \u2014 not because they\u2019re doing anything wrong, but because the opportunity is easy to miss.',
    p2:'We work specifically with law firms on SEO and digital growth. I\u2019d love to share a quick look at where you currently rank vs. where you could be \u2014 no pitch, just useful data.',
    p3:'Worth a 20-minute call this week?',signoff:'Best,',
    sender_name:'{{ sender.firstname }} {{ sender.lastname }}',sender_title:'Client Growth, Rankings.io',sender_email:'{{ sender.email }}',
    ps:'P.S. I put together a quick snapshot of your site\u2019s current search visibility \u2014 happy to send it over if useful.',color_accent:'#0A0A0A'},
  defaultBlocks:[],
  renderOpen(ff){return '';},
  renderClose(ff){return '';},
  renderFull(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:#EDECEA;font-family:Georgia,serif;">
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:#EDECEA;"><tr><td align="center" style="padding:36px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="560">
<tr><td style="padding-bottom:18px;"><table border="0" cellpadding="0" cellspacing="0"><tr>
  <td style="width:28px;height:2px;background:${ff.color_accent};font-size:0;">&nbsp;</td>
  <td style="width:6px;height:2px;background:#ccc;font-size:0;">&nbsp;</td>
  <td style="width:6px;height:2px;background:#ddd;font-size:0;">&nbsp;</td>
</tr></table></td></tr>
<tr><td style="background:#fff;padding:38px 40px 34px;border-top:2px solid ${ff.color_accent};">
  <p style="margin:0 0 26px;font-family:Arial,sans-serif;font-size:9px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#ccc;">${ff.company}</p>
  <p style="margin:0 0 20px;font-family:Georgia,serif;font-size:16px;line-height:1.8;color:#1a1a1a;">${ff.greeting}</p>
  <p style="margin:0 0 20px;font-family:Georgia,serif;font-size:16px;line-height:1.8;color:#1a1a1a;">${ff.p1}</p>
  <p style="margin:0 0 20px;font-family:Georgia,serif;font-size:16px;line-height:1.8;color:#1a1a1a;">${ff.p2}</p>
  <p style="margin:0 0 34px;font-family:Georgia,serif;font-size:16px;line-height:1.8;color:#1a1a1a;">${ff.p3}</p>
  <p style="margin:0 0 5px;font-family:Georgia,serif;font-size:16px;color:#1a1a1a;">${ff.signoff}</p>
  <p style="margin:0 0 2px;font-family:Arial,sans-serif;font-size:14px;font-weight:700;color:#0a0a0a;">${ff.sender_name}</p>
  <p style="margin:0 0 2px;font-family:Arial,sans-serif;font-size:12px;color:#888;">${ff.sender_title}</p>
  <p style="margin:0;font-family:Arial,sans-serif;font-size:12px;color:#888;">${ff.sender_email}</p>
</td></tr>
<tr><td style="background:#F4F3EF;padding:16px 40px;border-top:1px solid #E4E2DC;">
  <p style="margin:0;font-family:Georgia,serif;font-size:13px;line-height:1.7;color:#777;font-style:italic;">${ff.ps}</p>
</td></tr>
<tr><td style="padding:16px 0 0;">
  <p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:#bbb;">You received this as a business contact. <a href="{{ unsubscribe_link }}" style="color:#bbb;">Unsubscribe</a></p>
</td></tr>
</table></td></tr></table></body></html>`;
  }
},

followup:{
  label:'Follow-Up',
  frameFields:['company','greeting','context_note','p1','p2','ask','signoff','sender_name','sender_title','color_accent'],
  frameDefaults:{company:'Rankings.io',greeting:'Hey {{ contact.firstname }} \u2014',context_note:'Re: your firm\u2019s search visibility',
    p1:'I know inboxes are brutal, so I\u2019ll keep this short: I genuinely think there\u2019s an opportunity here worth 20 minutes of your time.',
    p2:'We\u2019ve helped firms like yours go from page 3 to page 1 for their most valuable search terms \u2014 and the compounding effect on inbound is significant.',
    ask:'If now\u2019s not the right time, just let me know and I\u2019ll follow up in a few months. No pressure.',
    signoff:'\u2014',sender_name:'{{ sender.firstname }}',sender_title:'Rankings.io',color_accent:'#0A0A0A'},
  defaultBlocks:[],
  renderOpen(ff){return '';},
  renderClose(ff){return '';},
  renderFull(ff){
    return `${EH}${EM}<body style="margin:0;padding:0;background:#fff;font-family:Georgia,serif;">
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background:#fff;"><tr><td align="center" style="padding:48px 16px;">
<table border="0" cellpadding="0" cellspacing="0" width="520">
<tr><td style="padding-bottom:32px;"><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td style="height:1px;background:#e8e8e8;font-size:0;">&nbsp;</td></tr></table></td></tr>
<tr><td style="padding-bottom:24px;"><p style="margin:0;font-family:Arial,sans-serif;font-size:9px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#ccc;">${ff.company}</p></td></tr>
<tr><td style="padding-bottom:24px;"><p style="margin:0;font-family:Arial,sans-serif;font-size:11px;color:#bbb;font-style:italic;">${ff.context_note}</p></td></tr>
<tr><td>
  <p style="margin:0 0 20px;font-family:Georgia,serif;font-size:16px;line-height:1.8;color:#111;">${ff.greeting}</p>
  <p style="margin:0 0 20px;font-family:Georgia,serif;font-size:16px;line-height:1.8;color:#111;">${ff.p1}</p>
  <p style="margin:0 0 20px;font-family:Georgia,serif;font-size:16px;line-height:1.8;color:#111;">${ff.p2}</p>
  <p style="margin:0 0 36px;font-family:Georgia,serif;font-size:16px;line-height:1.8;color:#111;">${ff.ask}</p>
</td></tr>
<tr><td style="border-top:1px solid #e8e8e8;padding-top:24px;">
  <p style="margin:0 0 6px;font-family:Georgia,serif;font-size:16px;color:#111;">${ff.signoff}</p>
  <p style="margin:0 0 2px;font-family:Arial,sans-serif;font-size:14px;font-weight:700;color:#111;">${ff.sender_name}</p>
  <p style="margin:0;font-family:Arial,sans-serif;font-size:12px;color:#bbb;">${ff.sender_title}</p>
</td></tr>
<tr><td style="padding-top:32px;"><p style="margin:0;font-family:Arial,sans-serif;font-size:10px;color:#ccc;"><a href="{{ unsubscribe_link }}" style="color:#ccc;text-decoration:none;">Unsubscribe</a></p></td></tr>
</table></td></tr></table></body></html>`;
  }
},

}};// end FRAMES

// ── HELPERS ───────────────────────────────────────────────────────────────────
const eh=s=>String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
const et=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
let _uid=1;
const uid=()=>'b'+(++_uid)+'_'+Math.random().toString(36).slice(2,6);

// ── INIT ─────────────────────────────────────────────────────────────────────
function init(){applyMode('marketing');}

function setMode(m){
  if(mode===m)return; mode=m;
  document.querySelectorAll('.mp button').forEach((b,i)=>{b.classList.toggle('on',(m==='marketing'&&i===0)||(m==='sales'&&i===1));});
  applyMode(m);
}

function applyMode(m){
  const sel=document.getElementById('ts');
  sel.innerHTML='';
  Object.entries(FRAMES[m]).forEach(([k,f])=>{
    const o=document.createElement('option');o.value=k;o.textContent=f.label;sel.appendChild(o);
  });
  tplKey=Object.keys(FRAMES[m])[0];
  loadFrame();
}

function setTpl(k){tplKey=k;loadFrame();}

function loadFrame(){
  const fr=FRAMES[mode][tplKey];
  ff={...fr.frameDefaults};
  blocks=fr.defaultBlocks.map(b=>({...b,fields:{...b.fields},id:uid()}));
  expandedBlks=new Set(blocks.map(b=>b.id));
  showPicker=false;
  buildSB();renderPrev();
}

// ── RENDER EMAIL ─────────────────────────────────────────────────────────────
function renderHTML(){
  const fr=FRAMES[mode][tplKey];
  if(fr.renderFull) return fr.renderFull(ff);
  const bodyRows=blocks.map(b=>{
    const def=BD[b.type];
    return def?def.render(b.fields,ff):'';
  }).join('\n');
  return fr.renderOpen(ff)+bodyRows+fr.renderClose(ff);
}

// ── SIDEBAR ───────────────────────────────────────────────────────────────────
function buildSB(){
  const fr=FRAMES[mode][tplKey];
  let h=`<div class="sh">Frame Settings</div>`;

  // Frame fields
  fr.frameFields.forEach(k=>{
    const lbl=FL[k]||k, val=ff[k]||'';
    if(FCOL.has(k)){
      const sw=BRAND.map(c=>`<div class="sw" style="background:${c.h};" title="${c.n}" onclick="abrand_ff('${k}','${c.h}')"></div>`).join('');
      h+=`<div class="fw"><div class="fl">${lbl}</div>
        <div class="cr"><input type="color" value="${eh(val)}" oninput="scolff('${k}',this)">
        <input type="text" class="fi" style="flex:1;" value="${eh(val)}" oninput="stxtff('${k}',this)"></div>
        <div class="swr">${sw}</div></div>`;
    } else if(FTA.has(k)){
      h+=`<div class="fw"><div class="fl">${lbl}</div><textarea class="fi" oninput="updff('${k}',this.value)">${et(val)}</textarea></div>`;
    } else {
      h+=`<div class="fw"><div class="fl">${lbl}</div><input type="text" class="fi" value="${eh(val)}" oninput="updff('${k}',this.value)"></div>`;
    }
  });

  // Blocks section (only for marketing)
  if(mode==='marketing'){
    h+=`<div class="sh" style="top:auto;">Sections</div>`;
    h+=`<div class="bk-list">`;
    blocks.forEach((bk,idx)=>{
      const def=BD[bk.type];
      if(!def)return;
      const open=expandedBlks.has(bk.id);
      h+=`<div class="bk" id="bk-${bk.id}">
        <div class="bk-hd" onclick="toggleBk('${bk.id}')">
          <div class="bk-ico">${def.icon}</div>
          <span class="bk-lbl">${def.label}</span>
          <div class="bk-acts" onclick="event.stopPropagation()">
            ${idx>0?`<button class="bk-btn" onclick="moveBk('${bk.id}',-1)" title="Move up">↑</button>`:''}
            ${idx<blocks.length-1?`<button class="bk-btn" onclick="moveBk('${bk.id}',1)" title="Move down">↓</button>`:''}
            <button class="bk-btn del" onclick="delBk('${bk.id}')" title="Remove">×</button>
          </div>
        </div>
        <div class="bk-body${open?' open':''}">
          ${renderBkFields(bk)}
        </div>
      </div>`;
    });
    h+=`</div>`;

    // Add block
    const picker_open=showPicker;
    h+=`<div class="add-bk-wrap">
      <button class="add-bk-btn" onclick="togglePicker()">+ Add Section</button>
      <div class="block-picker${picker_open?' open':''}">
        <div class="bp-grid">
          ${Object.entries(BD).map(([type,def])=>`
            <div class="bp-item" onclick="addBk('${type}')">
              <div class="bp-name">${def.label}</div>
              <div class="bp-sub">${{heading:'H1/H2/H3',text:'Body paragraph',image:'Photo or graphic',img_text:'Side-by-side',cta:'Button link',quote:'Pull quote',stats:'3 metric blocks',three_col:'3 image cards',two_col:'2 image columns',callout:'Highlight box',divider:'Horizontal rule',spacer:'Blank space'}[type]||''}</div>
            </div>`).join('')}
        </div>
      </div>
    </div>`;
  }

  // Merge tags
  h+=`<div class="sh" style="top:auto;">HubSpot Merge Tags</div>
  <div class="tw"><p class="tn">Click to copy, paste into any field.</p>`;
  Object.entries(MERGE).forEach(([g,tags])=>{
    h+=`<p class="tg">${g}</p><div class="tr_">${tags.map(t=>`<span class="tc" onclick="ctag('${t}')">${t}</span>`).join('')}</div>`;
  });
  h+=`</div>`;

  document.getElementById('sb').innerHTML=h;
}

function renderBkFields(bk){
  const def=BD[bk.type];
  if(!def)return '';
  let h='';
  def.fieldDefs.forEach(fd=>{
    const val=bk.fields[fd.k]||'';
    const oid=`bk-${bk.id}-${fd.k}`;
    if(fd.t==='image'){
      const hasImg=val.length>0;
      h+=`<div class="bk-field"><div class="fl">${fd.l}</div>
        <div class="iz${hasImg?' hi':''}" id="iz-${oid}"
          ondragover="event.preventDefault();this.classList.add('drag-over')"
          ondragleave="this.classList.remove('drag-over')"
          ondrop="dropBk(event,'${bk.id}','${fd.k}')"
          onclick="pickBk('${bk.id}','${fd.k}')">
          ${hasImg
            ?`<div class="iz-tw"><img class="iz-th" src="${eh(val)}" alt=""><button class="iz-rm" onclick="event.stopPropagation();clrBk('${bk.id}','${fd.k}')">Remove</button></div>`
            :`<div class="iz-hint"><svg class="iz-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><span class="iz-txt">Drop or click</span></div>`}
        </div>
        <input type="text" class="fi" placeholder="...or paste URL" value="${eh(val)}" oninput="updBkImg('${bk.id}','${fd.k}',this.value,'iz-${oid}')">
        <p class="in">Use hosted URL for actual sends.</p>
      </div>`;
    } else if(fd.t==='widthbtns'){
      const btns=['25','50','75','100'].map(w=>`<button class="bs${val===w?' on':''}" onclick="updBk('${bk.id}','${fd.k}','${w}')">${w}%</button>`).join('');
      h+=`<div class="bk-field"><div class="fl">${fd.l}</div><div class="bg">${btns}</div></div>`;
    } else if(fd.t==='alignbtns'){
      const btns=['left','center','right'].map(a=>`<button class="bs${val===a?' on':''}" onclick="updBk('${bk.id}','${fd.k}','${a}')">${a.charAt(0).toUpperCase()+a.slice(1)}</button>`).join('');
      h+=`<div class="bk-field"><div class="fl">${fd.l}</div><div class="bg">${btns}</div></div>`;
    } else if(fd.t==='select'){
      h+=`<div class="bk-field"><div class="fl">${fd.l}</div>
        <select class="fi" onchange="updBk('${bk.id}','${fd.k}',this.value)">
          ${(fd.opts||[]).map(o=>`<option value="${o}"${val===o?' selected':''}>${o.charAt(0).toUpperCase()+o.slice(1)}</option>`).join('')}
        </select></div>`;
    } else if(fd.t==='textarea'){
      h+=`<div class="bk-field"><div class="fl">${fd.l}</div><textarea class="fi" oninput="updBk('${bk.id}','${fd.k}',this.value)">${et(val)}</textarea></div>`;
    } else if(fd.t==='color'){
      const sw=BRAND.map(c=>`<div class="sw" style="background:${c.h};" title="${c.n}" onclick="updBk('${bk.id}','${fd.k}','${c.h}')"></div>`).join('');
      h+=`<div class="bk-field"><div class="fl">${fd.l}</div>
        <div class="cr"><input type="color" value="${eh(val)||'#ffffff'}" oninput="updBkCol('${bk.id}','${fd.k}',this)">
        <input type="text" class="fi" style="flex:1;" value="${eh(val)}" oninput="updBkColTxt('${bk.id}','${fd.k}',this)"></div>
        <div class="swr">${sw}</div></div>`;
    } else {
      h+=`<div class="bk-field"><div class="fl">${fd.l}</div>
        <input type="text" class="fi" value="${eh(val)}" oninput="updBk('${bk.id}','${fd.k}',this.value)"></div>`;
    }
  });
  return h;
}

// ── FRAME FIELD UPDATES ───────────────────────────────────────────────────────
function updff(k,v){ff[k]=v;renderPrev();}
function scolff(k,cp){ff[k]=cp.value;cp.parentNode.querySelector('input[type="text"]').value=cp.value;renderPrev();}
function stxtff(k,ti){ff[k]=ti.value;if(/^#[0-9A-Fa-f]{6}$/.test(ti.value))ti.parentNode.querySelector('input[type="color"]').value=ti.value;renderPrev();}
function abrand_ff(k,h){ff[k]=h;buildSB();renderPrev();}

// ── BLOCK OPS ─────────────────────────────────────────────────────────────────
function toggleBk(id){
  if(expandedBlks.has(id))expandedBlks.delete(id); else expandedBlks.add(id);
  buildSB();
}
function togglePicker(){showPicker=!showPicker;buildSB();}
function addBk(type){
  const def=BD[type];
  if(!def)return;
  const id=uid();
  const newBk={id,type,fields:{...def.defaults}};
  blocks.push(newBk);
  expandedBlks.add(id);
  showPicker=false;
  buildSB();renderPrev();
  // scroll to bottom of sidebar
  setTimeout(()=>{const sb=document.getElementById('sb');if(sb)sb.scrollTop=sb.scrollHeight;},50);
}
function delBk(id){
  blocks=blocks.filter(b=>b.id!==id);
  expandedBlks.delete(id);
  buildSB();renderPrev();
}
function moveBk(id,dir){
  const i=blocks.findIndex(b=>b.id===id);
  if(i<0)return;
  const j=i+dir;
  if(j<0||j>=blocks.length)return;
  [blocks[i],blocks[j]]=[blocks[j],blocks[i]];
  buildSB();renderPrev();
}
function updBk(id,k,v){
  const bk=blocks.find(b=>b.id===id);
  if(!bk)return;
  bk.fields[k]=v;
  // update active state on btn groups without full rebuild
  buildSB();renderPrev();
}
function updBkCol(id,k,cp){
  const bk=blocks.find(b=>b.id===id);if(!bk)return;
  bk.fields[k]=cp.value;
  const wrap=cp.closest('.bk-field');
  if(wrap){const t=wrap.querySelector('input[type="text"]');if(t)t.value=cp.value;}
  renderPrev();
}
function updBkColTxt(id,k,ti){
  const bk=blocks.find(b=>b.id===id);if(!bk)return;
  bk.fields[k]=ti.value;
  if(/^#[0-9A-Fa-f]{6}$/.test(ti.value)){const wrap=ti.closest('.bk-field');if(wrap){const c=wrap.querySelector('input[type="color"]');if(c)c.value=ti.value;}}
  renderPrev();
}

// Image in blocks
function pickBk(id,k){pendingImg=null;pendingImgBk={id,k};const f=document.getElementById('fui');f.value='';f.click();}
document.getElementById('fui').addEventListener('change',function(){
  if(!this.files||!this.files[0])return;
  const r=new FileReader();
  r.onload=e=>{
    if(pendingImgBk){
      const bk=blocks.find(b=>b.id===pendingImgBk.id);
      if(bk){bk.fields[pendingImgBk.k]=e.target.result;}
    }
    pendingImgBk=null;
    buildSB();renderPrev();
  };
  r.readAsDataURL(this.files[0]);
});
function dropBk(ev,id,k){
  ev.preventDefault();
  const zone=ev.currentTarget;zone.classList.remove('drag-over');
  const file=ev.dataTransfer.files[0];
  if(!file||!file.type.startsWith('image/'))return;
  const r=new FileReader();
  r.onload=e=>{const bk=blocks.find(b=>b.id===id);if(bk){bk.fields[k]=e.target.result;}buildSB();renderPrev();};
  r.readAsDataURL(file);
}
function updBkImg(id,k,url,zid){
  const bk=blocks.find(b=>b.id===id);if(!bk)return;
  bk.fields[k]=url;
  const z=document.getElementById(zid);
  if(!z)return;
  if(url){
    z.classList.add('hi');
    z.innerHTML=`<div class="iz-tw"><img class="iz-th" src="${eh(url)}" alt=""><button class="iz-rm" onclick="event.stopPropagation();clrBk('${id}','${k}')">Remove</button></div>`;
  } else {
    z.classList.remove('hi');
    z.innerHTML=`<div class="iz-hint"><svg class="iz-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><span class="iz-txt">Drop or click</span></div>`;
  }
  renderPrev();
}
function clrBk(id,k){const bk=blocks.find(b=>b.id===id);if(bk)bk.fields[k]='';buildSB();renderPrev();}

// ── PREVIEW ───────────────────────────────────────────────────────────────────
function renderPrev(){
  const fr=document.getElementById('pf');
  fr.srcdoc=renderHTML();
  fr.onload=()=>{try{fr.style.height=Math.max(fr.contentDocument.documentElement.scrollHeight,400)+'px';}catch(e){fr.style.height='700px';}};
}

// ── EXPORT ────────────────────────────────────────────────────────────────────
function copyHTML(){navigator.clipboard.writeText(renderHTML()).then(()=>toast('HTML copied'));}
function ctag(t){navigator.clipboard.writeText(t).then(()=>toast('Token copied'));}
function toast(msg){const el=document.getElementById('tst');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1800);}

init();
</script>
</body>
</html>
